<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Triagens Neonatais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSS incorporado diretamente -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        .card {
            border: none;
            border-radius: 15px;
        }
        
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
        }
        
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            border: none;
            padding: 10px 20px;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #0dcaf0 0%, #0ba8c9 100%);
            border: none;
            color: white;
            font-weight: 500;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #0ba8c9 0%, #098da8 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(11, 168, 201, 0.2);
        }
        
        #directUsgBtn {
            font-size: 1.1rem;
            border-radius: 10px;
            padding: 12px 15px;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .check-container {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .check-container label {
            margin-left: 5px;
            margin-right: 15px;
            font-size: 0.85rem;
        }
        
        .print-button {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .print-only {
            display: none;
        }
        
        /* Classes para compactação de impressão */
        .compact-print {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .print-compact-heading {
            margin: 0.3em 0 !important;
            font-size: 1em !important;
        }
        
        .print-compact-checks {
            font-size: 0.8em !important;
            margin-left: 5px !important;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                margin: 0;
                border-radius: 10px;
            }
        }
        
        /* Estilos para impressão */
        @media print {
            body {
                background-color: white;
                font-size: 11pt;
                color: black;
                margin: 0;
                padding: 0;
            }
            
            .container {
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            /* Esconder todos os elementos exceto os resultados */
            body > div.container > div.row > div.col-md-8 > *:not(#results) {
                display: none !important;
            }
            
            /* Esconder a interface de calculadora e o botão de impressão */
            #screeningForm, #directUsgBtn, #usgCranioCard, .btn, .print-button, 
            .container > .row > .col-md-8 > .card:not(#results .card) {
                display: none !important;
            }
            
            /* Classes específicas para controlar o que é ocultado na impressão */
            .no-print {
                display: none !important;
            }
            
            /* NÃO esconder o resumo do RN e sua lista - reverter regras anteriores */
            #patientSummaryHeader,
            #patientSummaryList,
            #results h3.h4:first-of-type,
            #results ul.list-group:first-of-type {
                display: block !important;
            }
            
            /* Mostrar apenas a parte de resultados */
            #results {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Remover cabeçalho desnecessário no cartão de resultados */
            #results .card-header, 
            #results h1, 
            #results h2.h4 {
                display: none !important;
            }
            
            /* Garantir que todos os exames sejam exibidos */
            #examsResults {
                display: block !important;
            }
            
            #examsResults h5, 
            #examsResults ul, 
            #examsResults li {
                display: block !important;
                visibility: visible !important;
                page-break-inside: avoid;
            }
            
            /* Corrigir problema das datas na impressão */
            .list-group-item {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                padding: 5px 10px !important;
                margin-bottom: 3px !important;
                width: 100% !important;
                page-break-inside: avoid !important;
            }
            
            .list-group-item > div {
                flex: 1 !important;
                margin-right: 10px !important;
            }
            
            /* Garantir que as datas dos exames (badges) sejam mostradas corretamente na impressão */
            .badge, 
            .list-group-item .badge,
            span.badge {
                display: inline-block !important;
                visibility: visible !important;
                min-width: 90px !important;
                white-space: nowrap !important;
                text-align: right !important;
                padding: 2px 6px !important;
                border: 1px solid #333 !important;
                background-color: white !important;
                color: black !important;
                margin-left: auto !important;
                font-weight: bold !important;
                font-size: 0.95em !important;
            }
            
            /* Mais regras para impressão... resumidas para economizar espaço */
            /* Outras regras de impressão estão no segundo bloco de CSS */
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h1 class="h3 mb-0 text-center">Calculadora de Triagens Neonatais</h1>
                    </div>
                    <div class="card-body">
                        <div class="d-grid mb-4">
                            <button type="button" class="btn btn-info" id="directUsgBtn">Cálculo do USG de Crânio</button>
                        </div>
                        <form id="screeningForm" class="mb-4">
                            <div class="mb-3">
                                <label for="babyName" class="form-label">Nome do RN:</label>
                                <input type="text" class="form-control" id="babyName" required>
                            </div>
                            <div class="mb-3">
                                <label for="birthDate" class="form-label">Data de Nascimento:</label>
                                <input type="date" class="form-control" id="birthDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Idade Gestacional:</label>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="gestationalAgeWeeks" min="20" max="45" required>
                                            <span class="input-group-text">semanas</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="gestationalAgeDays" min="0" max="6" value="0">
                                            <span class="input-group-text">dias</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="birthWeight" class="form-label">Peso ao Nascer:</label>
                                <input type="text" class="form-control" id="birthWeight" required>
                                <div class="form-text">Digite o peso em gramas (ex: 2500) ou quilos (ex: 2,5 ou 2.5). O sistema irá normalizar automaticamente.</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Calcular Datas</button>
                        </form>
                    </div>
                </div>
                
                <!-- Card para cálculo do USG de Crânio -->
                <div class="card shadow mb-4 d-none" id="usgCranioCard">
                    <div class="card-header bg-info text-white">
                        <h2 class="h4 mb-0">Acompanhamento de USG de Crânio</h2>
                    </div>
                    <div class="card-body">
                        <form id="usgCranioForm">
                            <div class="mb-3">
                                <label for="usgDate" class="form-label">Data do primeiro USG:</label>
                                <input type="date" class="form-control" id="usgDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Resultado do USG:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="usgResult" id="usgNormal" value="normal" checked>
                                    <label class="form-check-label" for="usgNormal">
                                        Normal
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="usgResult" id="usgHI" value="HI">
                                    <label class="form-check-label" for="usgHI">
                                        Hemorragia Grau I
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="usgResult" id="usgHII" value="HII">
                                    <label class="form-check-label" for="usgHII">
                                        Hemorragia Grau II
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="usgResult" id="usgHIII" value="HIII">
                                    <label class="form-check-label" for="usgHIII">
                                        Hemorragia Grau III
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="usgResult" id="usgHIV" value="HIV">
                                    <label class="form-check-label" for="usgHIV">
                                        Hemorragia Grau IV
                                    </label>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" id="voltarBtn">Voltar</button>
                                <button type="submit" class="btn btn-info flex-grow-1">Calcular Acompanhamento</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="results" class="d-none">
                    <!-- Botão de impressão -->
                    <div class="d-grid print-button">
                        <button type="button" class="btn btn-success mb-3" id="printButton">
                            <i class="bi bi-printer"></i> Imprimir Relatório
                        </button>
                    </div>

                    <div class="card shadow mb-4">
                        <div class="card-header bg-success text-white no-print">
                            <h2 class="h4 mb-0">Resultados</h2>
                        </div>
                        <div class="card-body">
                            <h3 class="h4 mb-3" id="patientSummaryHeader">Resumo do RN</h3>
                            <ul class="list-group mb-3" id="patientSummaryList">
                                <li class="list-group-item"><strong>Nome:</strong> <span id="resName"></span></li>
                                <li class="list-group-item"><strong>Data de Nascimento:</strong> <span id="resBirthDate"></span></li>
                                <li class="list-group-item"><strong>Idade Gestacional:</strong> <span id="resGestAge"></span> semanas</li>
                                <li class="list-group-item"><strong>Peso ao Nascer:</strong> <span id="resWeight"></span> g</li>
                            </ul>
                            
                            <h3 class="h4 mb-3">Datas das Triagens e Exames:</h3>
                            
                            <div id="examsResults"></div>
                            
                            <div id="usgResultsSection" class="d-none mt-4">
                                <h3 class="h4 mb-3">Acompanhamento do USG de Crânio:</h3>
                                <div id="usgResults"></div>
                            </div>
                            
                            <!-- Rodapé para impressão -->
                            <div class="print-only print-footer">
                                <p class="no-print">Data de emissão: <span id="printDate"></span></p>
                                <p>
                                    <span>______________________________</span><br>
                                    <span>Assinatura e carimbo do médico</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="error" class="alert alert-danger d-none" role="alert">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para fatores de risco de HPIV -->
    <div class="modal fade" id="riskFactorsModal" tabindex="-1" aria-labelledby="riskFactorsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="riskFactorsModalLabel">Fatores de Risco para HPIV</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>O RN possui algum dos seguintes fatores de risco?</p>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="dpp">
              <label class="form-check-label" for="dpp">
                Descolamento prematuro de placenta
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="reanimacao">
              <label class="form-check-label" for="reanimacao">
                Necessidade de reanimação neonatal
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="drogas">
              <label class="form-check-label" for="drogas">
                Uso de drogas vasoativas
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="acidose">
              <label class="form-check-label" for="acidose">
                Acidose severa
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="vm">
              <label class="form-check-label" for="vm">
                Ventilação mecânica
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="hipotermia">
              <label class="form-check-label" for="hipotermia">
                Protocolo de hipotermia
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" value="" id="sepse">
              <label class="form-check-label" for="sepse">
                Sepse
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmRiskFactors">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos principais
            const screeningForm = document.getElementById('screeningForm');
            const resultsDiv = document.getElementById('results');
            const usgCranioCard = document.getElementById('usgCranioCard');
            const usgCranioForm = document.getElementById('usgCranioForm');
            const examsResults = document.getElementById('examsResults');
            const usgResults = document.getElementById('usgResults');
            const usgResultsSection = document.getElementById('usgResultsSection');
            const errorDiv = document.getElementById('error');
            const printButton = document.getElementById('printButton');
            const printDateSpan = document.getElementById('printDate');
            
            // Elementos do formulário principal
            const babyNameInput = document.getElementById('babyName');
            const birthDateInput = document.getElementById('birthDate');
            const gestWeeksInput = document.getElementById('gestationalAgeWeeks');
            const gestDaysInput = document.getElementById('gestationalAgeDays');
            const birthWeightInput = document.getElementById('birthWeight');
            
            // Elementos para resultados do paciente
            const resNameSpan = document.getElementById('resName');
            const resBirthDateSpan = document.getElementById('resBirthDate');
            const resGestAgeSpan = document.getElementById('resGestAge');
            const resWeightSpan = document.getElementById('resWeight');
            
            // Modal de fatores de risco
            const riskFactorsModal = new bootstrap.Modal(document.getElementById('riskFactorsModal'));
            const confirmRiskFactorsBtn = document.getElementById('confirmRiskFactors');
            
            // Botões de navegação
            const directUsgBtn = document.getElementById('directUsgBtn');
            const voltarBtn = document.getElementById('voltarBtn');
            
            // Variáveis globais para armazenar dados do paciente
            let patientData = {};
            
            // Formatador de data
            function formatDate(dateString) {
                const options = { day: 'numeric', month: 'numeric', year: 'numeric' };
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', options);
            }
            
            // Adiciona dias a uma data
            function addDays(dateString, days) {
                const date = new Date(dateString);
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }
            
            // Limpar erro
            function clearError() {
                errorDiv.textContent = '';
                errorDiv.classList.add('d-none');
            }
            
            // Mostrar erro
            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            }
            
            // Calcular idade corrigida
            function calculateCorrectedAge(birthDate, gestWeeks, gestDays) {
                const totalGestDays = gestWeeks * 7 + gestDays;
                const correctionDays = 280 - totalGestDays; // 280 dias = 40 semanas
                
                // Se nasceu com 40 semanas ou mais, não há correção
                if (correctionDays <= 0) {
                    return birthDate;
                }
                
                // Adicionar dias para corrigir a idade
                return addDays(birthDate, correctionDays);
            }
            
            // Função para normalizar peso
            function normalizeWeight(weightStr) {
                // Remove espaços e substitui vírgula por ponto
                weightStr = weightStr.trim().replace(',', '.');
                
                // Converte para número
                const weight = parseFloat(weightStr);
                
                // Se o peso for menor que 10, assumimos que está em kg e convertemos para g
                if (weight < 10) {
                    return Math.round(weight * 1000);
                }
                
                return Math.round(weight);
            }
            
            // Função para calcular as datas de triagem
            function calculateScreeningDates(birthDate, gestWeeks, gestDays, birthWeight) {
                const results = {};
                const totalGestDays = gestWeeks * 7 + gestDays;
                
                // Cálculo da idade corrigida, se necessário
                const correctedDate = calculateCorrectedAge(birthDate, gestWeeks, gestDays);
                
                // USG de crânio
                results.usgCranio = {};
                
                if (birthWeight <= 1500 || totalGestDays < 32 * 7) {
                    // Para RN com menos de 1500g ou < 32 semanas
                    // 1º USG: entre 7 e 10 dias de vida
                    results.usgCranio.first = {
                        start: addDays(birthDate, 7),
                        end: addDays(birthDate, 10)
                    };
                    
                    // 2º USG: entre 28 e 30 dias de vida
                    results.usgCranio.second = {
                        start: addDays(birthDate, 28),
                        end: addDays(birthDate, 30)
                    };
                    
                    // 3º USG: na idade corrigida de 38-40 semanas
                    results.usgCranio.third = {
                        start: addDays(correctedDate, -14),
                        end: correctedDate
                    };
                } else {
                    results.usgCranio.noScreening = true;
                }
                
                // Fundo de olho
                results.fundoOlho = {};
                
                if (birthWeight <= 1500 || totalGestDays < 32 * 7) {
                    // Com 4 semanas de vida ou 31 semanas de idade corrigida (o que ocorrer por último)
                    const fourWeeksDate = addDays(birthDate, 28);
                    
                    // Calcular data quando atinge 31 semanas de idade corrigida
                    let weeksToAdd = 0;
                    if (totalGestDays < 31 * 7) {
                        weeksToAdd = 31 * 7 - totalGestDays;
                        weeksToAdd = Math.ceil(weeksToAdd / 7);
                    }
                    
                    const week31Date = addDays(birthDate, weeksToAdd * 7);
                    
                    // Usa a data mais tardia
                    const laterDate = new Date(fourWeeksDate) > new Date(week31Date) ? fourWeeksDate : week31Date;
                    
                    results.fundoOlho.first = {
                        date: laterDate
                    };
                } else {
                    results.fundoOlho.noScreening = true;
                }
                
                // Doença metabólica óssea
                results.dmo = {};
                
                if (birthWeight <= 1500) {
                    // Primeira coleta com 1 mês
                    results.dmo.first = {
                        date: addDays(birthDate, 30)
                    };
                    
                    // Segunda coleta com 2 meses
                    results.dmo.second = {
                        date: addDays(birthDate, 60)
                    };
                } else {
                    results.dmo.noScreening = true;
                }
                
                // Teste da orelhinha
                results.testOrelhinha = {};
                
                // Para todos: antes da alta ou até 1 mês
                results.testOrelhinha.first = {
                    start: birthDate,
                    end: addDays(birthDate, 30)
                };
                
                return results;
            }
            
            // Função para calcular acompanhamento de USG com base no resultado inicial
            function calculateUSGFollowup(usgDate, usgResult) {
                const results = {};
                
                // Baseado no resultado do USG
                switch (usgResult) {
                    case 'normal':
                        // Sem necessidade de acompanhamento
                        results.followup = "USG normal. Não necessita de acompanhamento adicional.";
                        results.noFollowup = true;
                        break;
                    case 'HI':
                        // Repetir em 7 dias
                        results.followup = {
                            date: addDays(usgDate, 7),
                            message: "Repetir USG em 7 dias"
                        };
                        break;
                    case 'HII':
                        // Repetir em 7 dias
                        results.followup = {
                            date: addDays(usgDate, 7),
                            message: "Repetir USG em 7 dias"
                        };
                        break;
                    case 'HIII':
                        // Repetir em 7 dias + USG semanal até estabilização
                        results.followup = {
                            date: addDays(usgDate, 7),
                            message: "Repetir USG em 7 dias e manter USGs semanais até estabilização"
                        };
                        break;
                    case 'HIV':
                        // Repetir em 7 dias + USG semanal até estabilização
                        results.followup = {
                            date: addDays(usgDate, 7),
                            message: "Repetir USG em 7 dias e manter USGs semanais até estabilização"
                        };
                        break;
                    default:
                        results.error = "Resultado de USG inválido";
                }
                
                return results;
            }
            
            // Formatar a string de período de data
            function formatDateRange(dateStart, dateEnd) {
                if (dateStart === dateEnd) {
                    return formatDate(dateStart);
                }
                return `${formatDate(dateStart)} a ${formatDate(dateEnd)}`;
            }
            
            // Criar item de lista com checkbox
            function createChecklistItem(text, date) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-start';
                
                const div = document.createElement('div');
                div.className = 'd-flex align-items-center';
                
                // Container para os checkboxes
                const checkContainer = document.createElement('div');
                checkContainer.className = 'check-container';
                
                // Checkbox para "Solicitado"
                const requestedCheck = document.createElement('input');
                requestedCheck.type = 'checkbox';
                requestedCheck.id = `requested_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                requestedCheck.className = 'form-check-input no-print';
                
                const requestedLabel = document.createElement('label');
                requestedLabel.htmlFor = requestedCheck.id;
                requestedLabel.className = 'no-print';
                requestedLabel.textContent = 'Solicitado';
                
                // Checkbox para "Verificado"
                const verifiedCheck = document.createElement('input');
                verifiedCheck.type = 'checkbox';
                verifiedCheck.id = `verified_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                verifiedCheck.className = 'form-check-input no-print';
                
                const verifiedLabel = document.createElement('label');
                verifiedLabel.htmlFor = verifiedCheck.id;
                verifiedLabel.className = 'no-print';
                verifiedLabel.textContent = 'Verificado';
                
                // Adicionar os checkboxes e labels ao container
                checkContainer.appendChild(requestedCheck);
                checkContainer.appendChild(requestedLabel);
                checkContainer.appendChild(verifiedCheck);
                checkContainer.appendChild(verifiedLabel);
                
                // Texto do item
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                
                div.appendChild(textSpan);
                div.appendChild(checkContainer);
                
                // Badge para a data
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary';
                badge.textContent = date;
                
                li.appendChild(div);
                li.appendChild(badge);
                
                return li;
            }
            
            // Exibir resultados
            function displayResults(screeningResults) {
                // Limpar resultados anteriores
                examsResults.innerHTML = '';
                
                // USG de Crânio
                const usgTitle = document.createElement('h5');
                usgTitle.className = 'mt-4 mb-2';
                usgTitle.textContent = 'USG de Crânio';
                
                const usgList = document.createElement('ul');
                usgList.className = 'list-group mb-4';
                
                if (screeningResults.usgCranio.noScreening) {
                    const li = createChecklistItem('Não necessita triagem', 'N/A');
                    usgList.appendChild(li);
                } else {
                    const firstUsg = createChecklistItem(
                        '1º USG de Crânio',
                        formatDateRange(screeningResults.usgCranio.first.start, screeningResults.usgCranio.first.end)
                    );
                    const secondUsg = createChecklistItem(
                        '2º USG de Crânio',
                        formatDateRange(screeningResults.usgCranio.second.start, screeningResults.usgCranio.second.end)
                    );
                    const thirdUsg = createChecklistItem(
                        '3º USG de Crânio (termo)',
                        formatDateRange(screeningResults.usgCranio.third.start, screeningResults.usgCranio.third.end)
                    );
                    
                    usgList.appendChild(firstUsg);
                    usgList.appendChild(secondUsg);
                    usgList.appendChild(thirdUsg);
                }
                
                examsResults.appendChild(usgTitle);
                examsResults.appendChild(usgList);
                
                // Fundo de Olho
                const fundoOlhoTitle = document.createElement('h5');
                fundoOlhoTitle.className = 'mt-4 mb-2';
                fundoOlhoTitle.textContent = 'Fundo de Olho';
                
                const fundoOlhoList = document.createElement('ul');
                fundoOlhoList.className = 'list-group mb-4';
                
                if (screeningResults.fundoOlho.noScreening) {
                    const li = createChecklistItem('Não necessita triagem', 'N/A');
                    fundoOlhoList.appendChild(li);
                } else {
                    const fundoOlho = createChecklistItem(
                        'Avaliação com oftalmologista',
                        formatDate(screeningResults.fundoOlho.first.date)
                    );
                    fundoOlhoList.appendChild(fundoOlho);
                }
                
                examsResults.appendChild(fundoOlhoTitle);
                examsResults.appendChild(fundoOlhoList);
                
                // Doença Metabólica Óssea
                const dmoTitle = document.createElement('h5');
                dmoTitle.className = 'mt-4 mb-2';
                dmoTitle.textContent = 'Doença Metabólica Óssea';
                
                const dmoList = document.createElement('ul');
                dmoList.className = 'list-group mb-4';
                
                if (screeningResults.dmo.noScreening) {
                    const li = createChecklistItem('Não necessita triagem', 'N/A');
                    dmoList.appendChild(li);
                } else {
                    const firstDmo = createChecklistItem(
                        '1ª coleta (Ca, P, FA)',
                        formatDate(screeningResults.dmo.first.date)
                    );
                    const secondDmo = createChecklistItem(
                        '2ª coleta (Ca, P, FA)',
                        formatDate(screeningResults.dmo.second.date)
                    );
                    
                    dmoList.appendChild(firstDmo);
                    dmoList.appendChild(secondDmo);
                }
                
                examsResults.appendChild(dmoTitle);
                examsResults.appendChild(dmoList);
                
                // Teste da Orelhinha
                const testOrelhinhaTitle = document.createElement('h5');
                testOrelhinhaTitle.className = 'mt-4 mb-2';
                testOrelhinhaTitle.textContent = 'Teste da Orelhinha';
                
                const testOrelhinhaList = document.createElement('ul');
                testOrelhinhaList.className = 'list-group mb-4';
                
                const testOrelhinha = createChecklistItem(
                    'Realizar teste',
                    formatDateRange(screeningResults.testOrelhinha.first.start, screeningResults.testOrelhinha.first.end)
                );
                
                testOrelhinhaList.appendChild(testOrelhinha);
                
                examsResults.appendChild(testOrelhinhaTitle);
                examsResults.appendChild(testOrelhinhaList);
                
                // Mostrar seção de resultados
                resultsDiv.classList.remove('d-none');
                
                // Definir data de impressão
                const today = new Date();
                printDateSpan.textContent = today.toLocaleDateString('pt-BR');
            }
            
            // Exibir resultados do USG
            function displayUSGResults(usgFollowupResults) {
                // Limpar resultados anteriores
                usgResults.innerHTML = '';
                
                const usgList = document.createElement('ul');
                usgList.className = 'list-group mb-4';
                
                if (usgFollowupResults.noFollowup) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = usgFollowupResults.followup;
                    usgList.appendChild(li);
                } else {
                    const followup = createChecklistItem(
                        usgFollowupResults.followup.message,
                        formatDate(usgFollowupResults.followup.date)
                    );
                    usgList.appendChild(followup);
                }
                
                usgResults.appendChild(usgList);
                usgResultsSection.classList.remove('d-none');
                
                // Mostrar seção de resultados
                resultsDiv.classList.remove('d-none');
                
                // Definir data de impressão
                const today = new Date();
                printDateSpan.textContent = today.toLocaleDateString('pt-BR');
            }
            
            // Event Listeners
            
            // Formulário principal
            screeningForm.addEventListener('submit', function(e) {
                e.preventDefault();
                clearError();
                
                try {
                    // Obter valores do formulário
                    const babyName = babyNameInput.value.trim();
                    const birthDate = birthDateInput.value;
                    const gestWeeks = parseInt(gestWeeksInput.value, 10);
                    const gestDays = parseInt(gestDaysInput.value, 10);
                    const birthWeightStr = birthWeightInput.value.trim();
                    
                    // Validar dados
                    if (!babyName || !birthDate || isNaN(gestWeeks) || isNaN(gestDays)) {
                        throw new Error('Preencha todos os campos corretamente');
                    }
                    
                    // Normalizar peso
                    const birthWeight = normalizeWeight(birthWeightStr);
                    
                    // Calcular datas de triagem
                    const screeningResults = calculateScreeningDates(birthDate, gestWeeks, gestDays, birthWeight);
                    
                    // Armazenar dados do paciente
                    patientData = {
                        name: babyName,
                        birthDate: birthDate,
                        gestAge: gestWeeks + (gestDays / 7).toFixed(1),
                        weight: birthWeight
                    };
                    
                    // Exibir dados do paciente
                    resNameSpan.textContent = patientData.name;
                    resBirthDateSpan.textContent = formatDate(patientData.birthDate);
                    resGestAgeSpan.textContent = patientData.gestAge;
                    resWeightSpan.textContent = patientData.weight;
                    
                    // Exibir resultados
                    displayResults(screeningResults);
                    
                    // Esconder o cartão de USG
                    usgCranioCard.classList.add('d-none');
                } catch (error) {
                    showError(error.message);
                }
            });
            
            // Formulário de USG
            usgCranioForm.addEventListener('submit', function(e) {
                e.preventDefault();
                clearError();
                
                try {
                    // Obter valores do formulário
                    const usgDate = document.getElementById('usgDate').value;
                    const usgResult = document.querySelector('input[name="usgResult"]:checked').value;
                    
                    // Validar dados
                    if (!usgDate) {
                        throw new Error('Selecione a data do USG');
                    }
                    
                    // Calcular acompanhamento
                    const usgFollowupResults = calculateUSGFollowup(usgDate, usgResult);
                    
                    // Verificar erro
                    if (usgFollowupResults.error) {
                        throw new Error(usgFollowupResults.error);
                    }
                    
                    // Exibir resultados
                    displayUSGResults(usgFollowupResults);
                    
                    // Esconder o cartão de USG
                    usgCranioCard.classList.add('d-none');
                } catch (error) {
                    showError(error.message);
                }
            });
            
            // Botão de USG direto
            directUsgBtn.addEventListener('click', function() {
                clearError();
                screeningForm.classList.add('d-none');
                usgCranioCard.classList.remove('d-none');
                resultsDiv.classList.add('d-none');
                usgResultsSection.classList.add('d-none');
            });
            
            // Botão voltar
            voltarBtn.addEventListener('click', function() {
                clearError();
                screeningForm.classList.remove('d-none');
                usgCranioCard.classList.add('d-none');
            });
            
            // Botão de impressão
            printButton.addEventListener('click', function() {
                window.print();
            });
            
            // Hook para o modal de fatores de risco (não usado nesta versão)
            confirmRiskFactorsBtn.addEventListener('click', function() {
                riskFactorsModal.hide();
            });
        });
    </script>
</body>
</html> 